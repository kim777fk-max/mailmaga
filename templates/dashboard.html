{% extends "base.html" %}
{% block title %}ダッシュボード{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 fw-bold mb-0">ダッシュボード</h1>
    <small class="text-muted">今日: {{ today }}</small>
  </div>
  {% if is_admin %}
  <a href="/cycle/new" class="btn btn-primary">
    <i class="bi bi-plus-circle me-1"></i>新規号を作成
  </a>
  {% endif %}
</div>

{% if current %}
<!-- 進行中の号 -->
<div class="card current-cycle-card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <i class="bi bi-lightning-charge-fill me-2"></i>
      <strong>進行中: メルマガいたしん vol.{{ current.vol }} （{{ current.delivery_year }}年{{ current.delivery_month }}月号）</strong>
    </div>
    <a href="/cycle/{{ current.id }}" class="btn btn-sm btn-light fw-semibold">
      詳細・操作 <i class="bi bi-arrow-right ms-1"></i>
    </a>
  </div>
  <div class="card-body">
    <!-- Step badges -->
    <div class="d-flex flex-wrap gap-2 mb-3">
      {% for step in steps %}
      {% set s = current.steps.get(step.key, {}) %}
      <div class="step-badge {{ 'done' if s.get('completed') else '' }}">
        <span class="step-num">{{ step.icon }}</span>
        <span class="step-name">{{ step.label }}</span>
        {% if s.get('completed') %}
        <i class="bi bi-check-circle-fill ms-1"></i>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    <!-- Progress bar -->
    <div class="d-flex justify-content-between mb-1">
      <small class="text-muted fw-semibold">進捗 {{ current.progress.completed }}/{{ current.progress.total }}</small>
      <small class="text-muted">{{ current.progress.pct }}%</small>
    </div>
    <div class="progress" style="height: 10px; border-radius: 5px;">
      <div class="progress-bar progress-bar-striped progress-bar-animated"
           style="width: {{ current.progress.pct }}%"></div>
    </div>
    <!-- Key dates -->
    <div class="row g-2 mt-2">
      <div class="col-auto">
        <span class="date-chip">
          <i class="bi bi-pencil me-1"></i>〆切: {{ current.schedule.deadline }}
        </span>
      </div>
      <div class="col-auto">
        <span class="date-chip">
          <i class="bi bi-send me-1"></i>テスト配信: {{ current.schedule.test_distribution }}
        </span>
      </div>
      <div class="col-auto">
        <span class="date-chip publish">
          <i class="bi bi-envelope-check me-1"></i>発行: {{ current.schedule.publish }}
        </span>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if cycles %}
<h5 class="fw-bold mb-3 mt-2">全号一覧</h5>
<div class="row g-3">
  {% for cycle in cycles %}
  <div class="col-md-6 col-lg-4">
    <div class="card cycle-card h-100 {{ 'border-primary shadow-sm' if current and cycle.id == current.id else '' }}">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <div class="fw-bold">vol.{{ cycle.vol }}</div>
            <div class="text-muted small">{{ cycle.delivery_year }}年{{ cycle.delivery_month }}月号</div>
          </div>
          {% if current and cycle.id == current.id %}
          <span class="badge bg-primary">進行中</span>
          {% elif cycle.schedule.publish < today %}
          <span class="badge bg-secondary">完了</span>
          {% endif %}
        </div>
        <div class="d-flex justify-content-between mb-1">
          <small class="text-muted">{{ cycle.progress.completed }}/{{ cycle.progress.total }}</small>
          <small class="text-muted">{{ cycle.progress.pct }}%</small>
        </div>
        <div class="progress mb-3" style="height: 6px; border-radius: 3px;">
          <div class="progress-bar" style="width: {{ cycle.progress.pct }}%"></div>
        </div>
        <div class="small text-muted">
          <i class="bi bi-calendar-check me-1"></i>発行: {{ cycle.schedule.publish }}
        </div>
      </div>
      <div class="card-footer bg-transparent pt-0">
        <a href="/cycle/{{ cycle.id }}" class="btn btn-sm btn-outline-primary w-100">
          詳細・操作
        </a>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% else %}
<div class="text-center py-5 text-muted">
  <i class="bi bi-inbox display-3"></i>
  <p class="mt-3 mb-4">まだ号が登録されていません</p>
  {% if is_admin %}
  <a href="/cycle/new" class="btn btn-primary btn-lg">
    <i class="bi bi-plus-circle me-2"></i>最初の号を作成する
  </a>
  {% endif %}
</div>
{% endif %}
{% endblock %}
