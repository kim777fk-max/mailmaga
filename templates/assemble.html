{% extends "base.html" %}
{% block title %}組版ツール vol.{{ cycle.vol }}{% endblock %}

{% block content %}
<div class="mb-3">
  <a href="/cycle/{{ cycle.id }}" class="text-muted text-decoration-none small">
    <i class="bi bi-chevron-left me-1"></i>vol.{{ cycle.vol }} {{ cycle.delivery_month }}月号 に戻る
  </a>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h3 fw-bold mb-0">
      <i class="bi bi-layout-text-window me-2"></i>メルマガ組版ツール
    </h1>
    <small class="text-muted">vol.{{ cycle.vol }} {{ cycle.delivery_year }}年{{ cycle.delivery_month }}月号</small>
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-primary" onclick="buildNewsletter()">
      <i class="bi bi-play-fill me-1"></i>組版を実行
    </button>
  </div>
</div>

<!-- XServer 直接読み込み -->
<div class="card mb-3 border-primary">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h6 class="mb-0 fw-bold">
      <i class="bi bi-cloud-download me-2"></i>XServerから直接読み込む
    </h6>
    <button class="btn btn-sm btn-light" type="button"
            data-bs-toggle="collapse" data-bs-target="#xs-collapse">
      開く／閉じる
    </button>
  </div>
  <div class="collapse show" id="xs-collapse">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-6">
          <label class="form-label fw-semibold small mb-1">共有URL</label>
          <input type="url" class="form-control form-control-sm" id="xs-url"
                 value="{{ cycle.xserver_url or '' }}"
                 placeholder="https://drive.rmc-itabashi.jp/index.php/s/XXXXXXXX">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold small mb-1">パスワード</label>
          <input type="password" class="form-control form-control-sm" id="xs-pw">
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100" onclick="fetchFromXServer()">
            <i class="bi bi-cloud-download me-1"></i>取得して一覧に追加
          </button>
        </div>
      </div>
      <div id="xs-status" class="mt-2" style="display:none;"></div>
    </div>
  </div>
</div>

{% if not articles %}
<div class="alert alert-warning" id="no-articles-msg">
  <i class="bi bi-folder-x me-2"></i>
  ローカルに原稿ファイルが見つかりません。上の「XServerから読み込む」か、
  <a href="/cycle/{{ cycle.id }}#tab-articles">原稿管理タブ</a>でフォルダを設定してください。
</div>
{% endif %}

{% if articles or True %}

<div class="row g-3">

  <!-- 左カラム: 設定 + 記事リスト -->
  <div class="col-lg-5">

    <!-- ヘッダー設定 -->
    <div class="card mb-3">
      <div class="card-header">
        <h6 class="mb-0 fw-bold"><i class="bi bi-card-heading me-2"></i>ヘッダー設定</h6>
      </div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-3">
            <label class="form-label small fw-semibold">Vol番号</label>
            <input type="number" class="form-control form-control-sm" id="hdr-vol"
                   value="{{ cycle.vol }}">
          </div>
          <div class="col-3">
            <label class="form-label small fw-semibold">年</label>
            <input type="number" class="form-control form-control-sm" id="hdr-year"
                   value="{{ cycle.delivery_year }}">
          </div>
          <div class="col-3">
            <label class="form-label small fw-semibold">月</label>
            <input type="number" class="form-control form-control-sm" id="hdr-month"
                   value="{{ cycle.delivery_month }}">
          </div>
          <div class="col-3">
            <label class="form-label small fw-semibold">日</label>
            <input type="number" class="form-control form-control-sm" id="hdr-day"
                   value="15" min="1" max="31">
          </div>
        </div>
        <div class="mt-2">
          <label class="form-label small fw-semibold">
            はじめに（原稿未提出の場合の代替テキスト）
            <span class="text-muted fw-normal">―「はじめに」の記事が提出済みの場合はそちらを優先</span>
          </label>
          <textarea class="form-control form-control-sm" id="hdr-intro" rows="3"
                    placeholder="編集長からのコメントなど（提出済み原稿がある場合は不要）"></textarea>
        </div>
      </div>
    </div>

    <!-- 記事リスト（ドラッグ＆ドロップ） -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold"><i class="bi bi-list-ul me-2"></i>記事一覧（ドラッグで並び替え）</h6>
        <span class="badge bg-secondary" id="article-count">{{ articles | length }}件</span>
      </div>
      <div class="card-body p-2">
        <div id="article-list">
          {% for art in articles %}
          <div class="article-item" data-id="{{ art.filename }}"
               data-dept="{{ art.dept }}" data-body="{{ art.body | e }}">
            <div class="d-flex align-items-start gap-2">
              <div class="drag-handle" title="ドラッグで並び替え">
                <i class="bi bi-grip-vertical"></i>
              </div>
              <div class="flex-grow-1 min-w-0">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-semibold small">{{ art.dept }}</span>
                  <div class="d-flex align-items-center gap-2">
                    <span class="text-muted" style="font-size:11px;">{{ art.modified }}</span>
                    <div class="form-check mb-0">
                      <input class="form-check-input include-check" type="checkbox"
                             checked id="chk-{{ loop.index }}">
                    </div>
                  </div>
                </div>
                <div class="text-muted small text-truncate mt-1" style="font-size:11px;">
                  {{ art.preview }}…
                </div>
              </div>
            </div>
            <!-- 展開して本文を表示 -->
            <details class="mt-1">
              <summary class="text-muted" style="font-size:11px; cursor:pointer;">
                本文を確認する
              </summary>
              <pre class="article-preview-text mt-1">{{ art.body }}</pre>
            </details>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

  </div>

  <!-- 右カラム: プレビュー -->
  <div class="col-lg-7">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold"><i class="bi bi-eye me-2"></i>組版プレビュー</h6>
        <div class="d-flex gap-2" id="export-btns" style="display:none!important;">
          <button class="btn btn-sm btn-success" onclick="copyNewsletter()">
            <i class="bi bi-clipboard-check me-1"></i>コピー
          </button>
          <button class="btn btn-sm btn-outline-primary" onclick="downloadNewsletter()">
            <i class="bi bi-download me-1"></i>ダウンロード
          </button>
        </div>
      </div>
      <div class="card-body p-0 d-flex flex-column">
        <div id="preview-placeholder" class="text-center text-muted py-5">
          <i class="bi bi-layout-text-window display-4 d-block mb-3"></i>
          「組版を実行」ボタンを押すと<br>ここにプレビューが表示されます
        </div>
        <div id="preview-area" style="display:none;" class="flex-grow-1 d-flex flex-column">
          <pre id="preview-text" class="newsletter-preview flex-grow-1"></pre>
        </div>
        <div id="copy-toast" class="copy-toast" style="display:none;">
          <i class="bi bi-check-circle-fill me-1"></i>クリップボードにコピーしました！
        </div>
      </div>
    </div>
  </div>

</div><!-- /row -->
{% endblock %}


{% block scripts %}
<!-- SortableJS (ドラッグ＆ドロップ) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js"></script>

<style>
.article-item {
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 10px 12px;
  margin-bottom: 6px;
  cursor: default;
  transition: box-shadow 0.15s, border-color 0.15s;
  user-select: none;
}
.article-item:hover { border-color: #bee3f8; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.article-item.sortable-ghost { opacity: 0.4; }
.article-item.sortable-drag  { box-shadow: 0 8px 24px rgba(0,0,0,0.15); }

.article-item.excluded {
  opacity: 0.45;
  background: #f7f8fc;
}

.drag-handle {
  color: #a0aec0;
  cursor: grab;
  padding: 2px 4px;
  font-size: 16px;
  flex-shrink: 0;
}
.drag-handle:active { cursor: grabbing; }

.article-preview-text {
  font-family: 'Courier New', monospace;
  font-size: 11px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  padding: 8px;
  white-space: pre-wrap;
  word-break: break-all;
  max-height: 150px;
  overflow-y: auto;
}

.newsletter-preview {
  font-family: 'Courier New', 'Hiragino Sans', monospace;
  font-size: 13px;
  white-space: pre-wrap;
  word-break: break-all;
  padding: 20px;
  background: #fafafa;
  margin: 0;
  min-height: 400px;
  line-height: 1.9;
}

.copy-toast {
  position: fixed;
  bottom: 24px; right: 24px;
  background: #38a169; color: white;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 9999;
}
</style>

<script>
let _newsletterText = '';
let _xsHost = '', _xsToken = '', _xsPw = '';

// ── ドラッグ＆ドロップ初期化 ──
const listEl = document.getElementById('article-list');
if (listEl) {
  Sortable.create(listEl, {
    animation: 150,
    handle: '.drag-handle',
    ghostClass: 'sortable-ghost',
    dragClass: 'sortable-drag',
  });

  // チェックボックスのON/OFFで記事を薄表示
  listEl.addEventListener('change', e => {
    if (!e.target.classList.contains('include-check')) return;
    const item = e.target.closest('.article-item');
    item.classList.toggle('excluded', !e.target.checked);
  });
}

// ── XServer から取得 ────────────────────────────────────────────────────────
async function fetchFromXServer() {
  const url      = document.getElementById('xs-url').value.trim();
  const pw       = document.getElementById('xs-pw').value;
  const statusEl = document.getElementById('xs-status');
  if (!url) { alert('URLを入力してください'); return; }

  statusEl.style.display = 'block';
  statusEl.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>XServerに接続中...';

  // URLをサーバーに保存（次回自動入力用）
  fetch('/api/cycle/{{ cycle.id }}/xserver-save-url', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ url }),
  });

  statusEl.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>XServerからZIPをダウンロード中...（数秒かかります）';

  // ZIP一括取得 → サーバー側でパース済みの記事リストが返る
  let result;
  try {
    const res = await fetch('/api/cycle/{{ cycle.id }}/xserver-list', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ url, password: pw }),
    });
    result = await res.json();
  } catch (e) {
    statusEl.innerHTML = `<div class="alert alert-danger py-2 mb-0">通信エラー: ${e}</div>`;
    return;
  }

  if (result.error) {
    statusEl.innerHTML = `<div class="alert alert-danger py-2 mb-0"><i class="bi bi-exclamation-triangle me-1"></i>${result.error}</div>`;
    return;
  }

  const articles = result.articles || [];
  if (articles.length === 0) {
    statusEl.innerHTML = '<div class="alert alert-warning py-2 mb-0">原稿ファイル（.txt）が見つかりませんでした。「原稿提出」フォルダに .txt ファイルが保存されているか確認してください。</div>';
    return;
  }

  articles.forEach(a => addArticleItemToList(a.filename, a.dept, a.body, a.preview));
  updateArticleCount();
  const noMsg = document.getElementById('no-articles-msg');
  if (noMsg) noMsg.style.display = 'none';

  statusEl.innerHTML = `<div class="alert alert-success py-2 mb-0">
    <i class="bi bi-check-circle me-1"></i>
    <strong>${articles.length}件</strong>の原稿を読み込みました
  </div>`;
}

function addArticleItemToList(filename, dept, body, preview) {
  if (document.querySelector('[data-id="' + filename + '"]')) return;  // 重複スキップ

  const div = document.createElement('div');
  div.className   = 'article-item';
  div.dataset.id   = filename;
  div.dataset.dept = dept || filename;
  div.dataset.body = body;

  const prev = (preview || body.substring(0, 80)).replace(/\n/g, ' ');
  const bodyH = body.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  div.innerHTML = `
    <div class="d-flex align-items-start gap-2">
      <div class="drag-handle" title="ドラッグで並び替え"><i class="bi bi-grip-vertical"></i></div>
      <div class="flex-grow-1 min-w-0">
        <div class="d-flex justify-content-between align-items-center">
          <span class="fw-semibold small">${dept || filename}
            <span class="badge bg-info text-dark ms-1" style="font-size:10px;">XServer</span>
          </span>
          <div class="form-check mb-0">
            <input class="form-check-input include-check" type="checkbox" checked>
          </div>
        </div>
        <div class="text-muted small text-truncate mt-1" style="font-size:11px;">${prev}…</div>
      </div>
    </div>
    <details class="mt-1">
      <summary class="text-muted" style="font-size:11px;cursor:pointer;">本文を確認する</summary>
      <pre class="article-preview-text mt-1">${bodyH}</pre>
    </details>`;

  div.querySelector('.include-check').addEventListener('change', e => {
    div.classList.toggle('excluded', !e.target.checked);
  });
  document.getElementById('article-list').appendChild(div);
}

function updateArticleCount() {
  const n = document.querySelectorAll('#article-list .article-item').length;
  const b = document.getElementById('article-count');
  if (b) b.textContent = n + '件';
}

// ── 組版実行 ──
async function buildNewsletter() {
  const items = document.querySelectorAll('#article-list .article-item');
  const order = [];

  items.forEach(item => {
    const chk = item.querySelector('.include-check');
    if (!chk || !chk.checked) return;  // 除外チェックされているものはスキップ

    order.push({
      id:   item.dataset.id,
      dept: item.dataset.dept,
      body: item.dataset.body,
    });
  });

  if (order.length === 0) {
    alert('掲載する記事が選択されていません。チェックボックスをONにしてください。');
    return;
  }

  const header = {
    vol:            document.getElementById('hdr-vol').value,
    year:           document.getElementById('hdr-year').value,
    month:          document.getElementById('hdr-month').value,
    day:            document.getElementById('hdr-day').value,
    intro_fallback: document.getElementById('hdr-intro').value,
  };

  const btn = document.querySelector('button[onclick="buildNewsletter()"]');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>組版中...';

  try {
    const res = await fetch('/api/cycle/{{ cycle.id }}/build-newsletter', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ order, header }),
    });
    const data = await res.json();

    _newsletterText = data.text;
    document.getElementById('preview-placeholder').style.display = 'none';
    document.getElementById('preview-area').style.display = 'flex';
    document.getElementById('preview-text').textContent = _newsletterText;
    document.getElementById('export-btns').style.display = 'flex';

    // スクロールをプレビュートップへ
    document.getElementById('preview-text').scrollTop = 0;

  } catch (err) {
    alert('エラーが発生しました: ' + err);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-play-fill me-1"></i>組版を実行';
  }
}

// ── コピー ──
function copyNewsletter() {
  if (!_newsletterText) return;
  navigator.clipboard.writeText(_newsletterText).then(() => {
    const toast = document.getElementById('copy-toast');
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, 2500);
  });
}

// ── ダウンロード ──
function downloadNewsletter() {
  if (!_newsletterText) return;
  const vol   = document.getElementById('hdr-vol').value;
  const year  = document.getElementById('hdr-year').value;
  const month = String(document.getElementById('hdr-month').value).padStart(2, '0');
  const day   = String(document.getElementById('hdr-day').value).padStart(2, '0');
  const fname = `melmaga_vol${vol}_${year}${month}${day}.txt`;

  const blob = new Blob([_newsletterText], { type: 'text/plain;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = fname;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
{% endblock %}
